<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inicio de Sesión - UPIICSA</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* ESTILOS PARA LA VERIFICACIÓN */
        #verificacion-form {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .verification-message {
            background: #e8f5e8;
            border: 1px solid #1A8C14;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .boton-secundario {
            background: transparent;
            color: #1A8C14;
            border: 2px solid #1A8C14;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }

        .boton-secundario:hover {
            background: #1A8C14;
            color: white;
        }

        .timer-section {
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
    </style>
</head>
<body>
<header>
    <img src="Imagenes/ipn.png" alt="IPN" class="logo">
    <div class="title">Sistema de Prácticas Profesionales</div>
    <img src="Imagenes/logo blanco.png" alt="UPIICSA" class="logo">
</header>

<div class="main-container">
    <div class="form-container">
        <div class="tabs-wrapper">
            <button id="btn-login" class="active" onclick="mostrarLogin()">Inicio Sesión</button>
            <button id="btn-registro" class="inactive" onclick="mostrarRegistro()">Registrarse</button>
        </div>

        <!-- FORMULARIO LOGIN -->
        <div id="login-form">
            <h3>Iniciar Sesión</h3>
            <div class="form-group">
                <label for="login-email" class="required">Correo electrónico</label>
                <input type="email" id="login-email" placeholder="usuario@ejemplo.com">
                <div class="error-message" id="login-email-error">Por favor ingresa un correo electrónico válido</div>
            </div>
            <div class="form-group">
                <label for="login-password" class="required">Contraseña</label>
                <input type="password" id="login-password" placeholder="Ingresa tu contraseña">
                <div class="error-message" id="login-password-error">La contraseña es requerida</div>
            </div>
            <button class="boton-form" id="login-button" onclick="validarLogin(); return false;">Iniciar Sesión</button>
            <div class="footer"><a href="#">¿Olvidaste tu contraseña?</a></div>
        </div>

        <!-- FORMULARIO REGISTRO -->
        <div id="registro-form" style="display: none;">
            <h3>Crear Cuenta</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="nombre" class="required">Nombre(s)</label>
                    <input type="text" id="nombre" placeholder="Tu nombre">
                    <div class="error-message" id="nombre-error">El nombre es requerido</div>
                </div>
                <div class="form-group">
                    <label for="apellido-paterno" class="required">Apellido Paterno</label>
                    <input type="text" id="apellido-paterno" placeholder="Apellido paterno">
                    <div class="error-message" id="apellido-paterno-error">El apellido paterno es requerido</div>
                </div>
                <div class="form-group">
                    <label for="apellido-materno" class="required">Apellido Materno</label>
                    <input type="text" id="apellido-materno" placeholder="Apellido materno">
                    <div class="error-message" id="apellido-materno-error">El apellido materno es requerido</div>
                </div>
                <div class="form-group">
                    <label for="boleta" class="required">Boleta</label>
                    <input type="text" id="boleta" placeholder="Número de boleta" maxlength="10">
                    <div class="character-count" id="boleta-count">0/10 dígitos</div>
                    <div class="error-message" id="boleta-error">La boleta debe contener exactamente 10 dígitos</div>
                </div>
                <div class="form-group">
                    <label for="escuela" class="required">Escuela</label>
                    <select id="escuela">
                        <option value="upiicsa" selected>UPIICSA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="carrera" class="required">Carrera</label>
                    <select id="carrera">
                        <option value="">Selecciona una carrera</option>
                        <option value="transporte">Ingeniería en Transporte</option>
                        <option value="informatica">Ingeniería en Informática</option>
                        <option value="industrial">Ingeniería Industrial</option>
                        <option value="ferroviaria">Ingeniería Ferroviaria</option>
                        <option value="ciencias">Ciencias de la Informática</option>
                        <option value="administracion">Administración Industrial</option>
                        <option value="sisa">Ingeniería en Sistemas Automotrices</option>
                    </select>
                    <div class="error-message" id="carrera-error">Debes seleccionar una carrera</div>
                </div>
                <div class="form-group">
                    <label for="plan-estudios" class="required">Plan de Estudios</label>
                    <select id="plan-estudios">
                        <option value="">Primero selecciona una carrera</option>
                    </select>
                    <div class="error-message" id="plan-estudios-error">Debes seleccionar un plan de estudios</div>
                </div>
                <div class="form-group half-width">
                    <label for="email" class="required">Correo electrónico</label>
                    <input type="email" id="email" placeholder="usuario@ejemplo.com">
                    <div class="error-message" id="email-error">Por favor ingresa un correo electrónico válido</div>
                </div>
                <div class="form-group">
                    <label for="password" class="required">Contraseña</label>
                    <input type="password" id="password" placeholder="Crea una contraseña">
                    <div class="error-message" id="password-error">La contraseña no cumple con los requisitos</div>
                    <div class="password-rules">
                        <strong>La contraseña debe contener:</strong>
                        <ul>
                            <li id="rule-length" class="rule-invalid">Al menos 6 caracteres</li>
                            <li id="rule-uppercase" class="rule-invalid">Al menos una letra mayúscula</li>
                            <li id="rule-number" class="rule-invalid">Al menos un número</li>
                            <li id="rule-special" class="rule-invalid">Al menos un carácter especial</li>
                        </ul>
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirm-password" class="required">Confirmar Contraseña</label>
                    <input type="password" id="confirm-password" placeholder="Repite tu contraseña">
                    <div class="error-message" id="confirm-password-error">Las contraseñas no coinciden</div>
                </div>
                <div class="form-group small-width">
                    <label for="phone" class="required">Teléfono</label>
                    <input type="tel" id="phone" placeholder="Número de teléfono" maxlength="10">
                    <div class="character-count" id="phone-count">0/10 dígitos</div>
                    <div class="error-message" id="phone-error">El teléfono debe contener exactamente 10 dígitos</div>
                </div>
            </div>
            <button class="boton-form" id="register-button" onclick="iniciarRegistro(); return false;">Registrarse</button>
            <div class="footer">
                Al registrarte, aceptas nuestros <a href="#">Términos de servicio</a> y <a href="#">Política de privacidad</a>
            </div>
        </div>

        <!-- FORMULARIO VERIFICACIÓN -->
        <div id="verificacion-form">
            <h3>Verifica tu correo electrónico</h3>
            <div class="verification-message">
                <p>Hemos enviado un código de verificación a: <strong id="email-destino"></strong></p>
                <p>Revisa tu bandeja de entrada y spam.</p>
            </div>
            <div class="form-group">
                <label for="codigo-verificacion" class="required">Código de verificación</label>
                <input type="text" id="codigo-verificacion" placeholder="Ingresa el código de 6 dígitos" maxlength="6">
                <div class="error-message" id="codigo-error">El código es requerido</div>
            </div>
            <div class="timer-section">
                <p id="timer-text">Puedes solicitar un nuevo código en: <span id="countdown">60</span> segundos</p>
                <button type="button" id="resend-button" class="boton-secundario" disabled onclick="reenviarCodigo(); return false;">Reenviar código</button>
            </div>
            <button class="boton-form" id="verify-button" onclick="verificarCodigo(); return false;">Verificar y Completar Registro</button>
            <button class="boton-secundario" onclick="volverAlRegistro(); return false;">← Volver al registro</button>
        </div>
    </div>
</div>

<script>
    // ========== VARIABLES GLOBALES ==========
    const API_BASE_URL = window.location.origin;
    let emailRegistro = '';
    let datosEstudianteTemporal = null;
    let countdownTimer = null;

    // ========== FUNCIONES DE NAVEGACIÓN (YA FUNCIONAN) ==========
    function mostrarLogin() {
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('registro-form').style.display = 'none';
        document.getElementById('verificacion-form').style.display = 'none';

        document.getElementById('btn-login').classList.add('active');
        document.getElementById('btn-login').classList.remove('inactive');
        document.getElementById('btn-registro').classList.remove('active');
        document.getElementById('btn-registro').classList.add('inactive');

        if (countdownTimer) clearInterval(countdownTimer);
    }

    function mostrarRegistro() {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('registro-form').style.display = 'block';
        document.getElementById('verificacion-form').style.display = 'none';

        document.getElementById('btn-login').classList.remove('active');
        document.getElementById('btn-login').classList.add('inactive');
        document.getElementById('btn-registro').classList.add('active');
        document.getElementById('btn-registro').classList.remove('inactive');

        if (countdownTimer) clearInterval(countdownTimer);
    }

    function mostrarVerificacion() {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('registro-form').style.display = 'none';
        document.getElementById('verificacion-form').style.display = 'block';

        document.getElementById('email-destino').textContent = emailRegistro;
        iniciarCountdown();
    }

    function volverAlRegistro() {
        mostrarRegistro();
    }

    // ========== FUNCIONES DE VERIFICACIÓN (SIMULACIÓN) ==========
    function iniciarCountdown() {
        let tiempoRestante = 60;
        const countdownElement = document.getElementById('countdown');
        const resendButton = document.getElementById('resend-button');
        const timerText = document.getElementById('timer-text');

        countdownElement.textContent = tiempoRestante;
        resendButton.disabled = true;
        timerText.style.display = 'block';

        countdownTimer = setInterval(() => {
            tiempoRestante--;
            countdownElement.textContent = tiempoRestante;

            if (tiempoRestante <= 0) {
                clearInterval(countdownTimer);
                resendButton.disabled = false;
                timerText.style.display = 'none';
            }
        }, 1000);
    }

    async function reenviarCodigo() {
        try {
            const boton = document.getElementById('resend-button');
            boton.textContent = 'Enviando...';
            boton.disabled = true;

            // Simular envío de código
            await new Promise(resolve => setTimeout(resolve, 1000));

            alert('¡Código reenviado! Revisa tu correo.');
            iniciarCountdown();

        } catch (error) {
            alert('Error al reenviar código: ' + error.message);
        } finally {
            const boton = document.getElementById('resend-button');
            boton.textContent = 'Reenviar código';
        }
    }

    // ========== REGISTRO REAL CON TU BACKEND ==========
    async function iniciarRegistro() {
        // Primero validar el formulario
        const esValido = validarFormularioRegistro();

        if (esValido) {
            const boton = document.getElementById('register-button');
            const textoOriginal = boton.textContent;
            boton.textContent = 'Enviando código...';
            boton.disabled = true;

            try {
                emailRegistro = document.getElementById('email').value;

                // Guardar datos para el registro final
                datosEstudianteTemporal = {
                    email: emailRegistro,
                    password: document.getElementById('password').value,
                    confirmPassword: document.getElementById('confirm-password').value,
                    name: document.getElementById('nombre').value,
                    fatherLastName: document.getElementById('apellido-paterno').value,
                    motherLastName: document.getElementById('apellido-materno').value,
                    enrollment: document.getElementById('boleta').value,
                    phone: document.getElementById('phone').value,
                    school: "UPIICSA",
                    career: mapearCarreraAEnum(document.getElementById('carrera').value)
                };

                console.log('Preparando registro para:', emailRegistro);

                // SIMULACIÓN: En lugar de enviar código, mostrar directamente la verificación
                // En producción aquí llamarías a tu API de envío de código
                await new Promise(resolve => setTimeout(resolve, 1000));

                mostrarVerificacion();

            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
                boton.textContent = textoOriginal;
                boton.disabled = false;
            }
        }
    }

    async function verificarCodigo() {
        const codigo = document.getElementById('codigo-verificacion').value;

        if (!codigo || codigo.length !== 6) {
            document.getElementById('codigo-verificacion').classList.add('input-error');
            document.getElementById('codigo-error').style.display = 'block';
            return;
        }

        const boton = document.getElementById('verify-button');
        const textoOriginal = boton.textContent;
        boton.textContent = 'Verificando...';
        boton.disabled = true;

        try {
            // SIMULACIÓN: Aquí verificarías el código con tu backend
            // Por ahora simulamos una verificación exitosa
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Una vez verificado, hacer el registro REAL
            await completarRegistro();

        } catch (error) {
            console.error('Error al verificar código:', error);
            alert('Error: ' + error.message);
            boton.textContent = textoOriginal;
            boton.disabled = false;
        }
    }

    async function completarRegistro() {
        try {
            console.log('Completando registro REAL con:', datosEstudianteTemporal);

            // ESTA ES LA PARTE QUE SE CONECTA CON TU BACKEND REAL
            const resultado = await registrarEstudianteAPI(datosEstudianteTemporal);

            alert('¡Registro completado exitosamente! Ahora puedes iniciar sesión.');
            mostrarLogin();

        } catch (error) {
            console.error('Error al completar registro:', error);
            alert('Error en el registro: ' + error.message);
        }
    }

    // ========== TU BACKEND REAL (YA EXISTE) ==========
    async function registrarEstudianteAPI(datosEstudiante) {
        try {
            console.log('Enviando datos de registro a tu backend:', datosEstudiante);
            const response = await fetch(`${API_BASE_URL}/students/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(datosEstudiante)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Error en el registro');
            }

            return await response.json();
        } catch (error) {
            console.error('Error API registro:', error);
            throw error;
        }
    }

    // ========== VALIDACIÓN DEL FORMULARIO (TU CÓDIGO) ==========
    function validarFormularioRegistro() {
        const nombre = document.getElementById('nombre').value;
        const apellidoPaterno = document.getElementById('apellido-paterno').value;
        const apellidoMaterno = document.getElementById('apellido-materno').value;
        const boleta = document.getElementById('boleta').value;
        const carrera = document.getElementById('carrera').value;
        const planEstudios = document.getElementById('plan-estudios').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const phone = document.getElementById('phone').value;

        let esValido = true;

        // Tu lógica de validación aquí...
        if (nombre.trim().length === 0) {
            mostrarError('nombre', 'El nombre es requerido');
            esValido = false;
        } else {
            ocultarError('nombre');
        }

        if (!validarEmail(email)) {
            mostrarError('email', 'Por favor ingresa un correo electrónico válido');
            esValido = false;
        } else {
            ocultarError('email');
        }

        // ... resto de validaciones

        return esValido;
    }

    function mostrarError(campoId, mensaje) {
        document.getElementById(campoId).classList.add('input-error');
        document.getElementById(`${campoId}-error`).textContent = mensaje;
        document.getElementById(`${campoId}-error`).style.display = 'block';
    }

    function ocultarError(campoId) {
        document.getElementById(campoId).classList.remove('input-error');
        document.getElementById(`${campoId}-error`).style.display = 'none';
    }

    function validarEmail(email) {
        const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        return regex.test(email);
    }

    function mapearCarreraAEnum(carreraFrontend) {
        const mapeo = {
            'transporte': 'ING_TRANSPORTE',
            'informatica': 'ING_INFORMATICA',
            'industrial': 'ING_INDUSTRIAL',
            'ferroviaria': 'ING_FERROVIARIA',
            'ciencias': 'CIE_INFORMATICA',
            'administracion': 'ADM_INDUSTRIAL',
            'sisa': 'ING_INFORMATICA'
        };
        return mapeo[carreraFrontend] || 'ING_INFORMATICA';
    }

    // ========== INICIALIZACIÓN ==========
    document.addEventListener('DOMContentLoaded', function() {
        mostrarLogin();
        // Aquí tu código de inicialización de event listeners...
    });

    // ... el resto de tus funciones (validarLogin, etc.)
</script>
</body>
</html>