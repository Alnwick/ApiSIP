<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Restablecer Contraseña - ApiSIP</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1A8C14;
            --primary-dark: #136b10;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #d1d5db;
            --white: #ffffff;
            --bg-input: #f8fafc;
            --error: #ef4444;
            --success: #10b981;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            background: var(--white);
            height: 100vh;
            overflow: hidden;
        }

        /* --- LAYOUT SPLIT-SCREEN (Reutilizado de index) --- */
        .split-layout { display: flex; height: 100%; width: 100%; }

        .brand-panel {
            flex: 0 0 50%;
            background: url('Imagenes/fondo.png') no-repeat center center/cover;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .brand-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #1A8C14; opacity: 0.50;
        }

        .brand-content { position: relative; z-index: 2; text-align: center; padding: 2rem; max-width: 600px; }
        .logos-container { display: flex; justify-content: center; gap: 2.5rem; margin-bottom: 2rem; }
        .brand-logo { height: 90px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }
        .brand-content h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem; line-height: 1.1; }
        .brand-content p { font-size: 1.1rem; opacity: 0.95; font-weight: 400; line-height: 1.5; }
        .brand-footer { position: absolute; bottom: 1.5rem; width: 100%; text-align: center; opacity: 0.7; font-size: 0.8rem; }

        /* LADO DERECHO */
        .form-panel {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--white);
            position: relative;
            padding: 1rem;
        }

        .form-wrapper {
            width: 100%; max-width: 450px; padding: 2rem; text-align: center;
            opacity: 0; animation: fadeIn 0.5s ease forwards;
        }
        @keyframes fadeIn { to { opacity: 1; } }

        .view-header { margin-bottom: 2rem; }
        .view-header h2 { font-size: 1.8rem; color: var(--primary-dark); font-weight: 800; margin-bottom: 0.5rem; }
        .view-header p { color: var(--text-muted); font-size: 0.95rem; line-height: 1.5; }

        /* INPUTS */
        .input-group-modern { margin-bottom: 1rem; text-align: left; }
        .input-group-modern label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-main); margin-bottom: 0.3rem; text-transform: uppercase; }
        .input-group-modern input {
            width: 100%; padding: 0.6rem 0.8rem; border: 1px solid var(--border);
            border-radius: 0.5rem; background: var(--bg-input); font-size: 0.9rem; color: var(--text-main); height: 42px; transition: all 0.2s;
        }
        .input-group-modern input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); outline: none; background: white; }

        /* REGLAS DE CONTRASEÑA */
        .password-rules {
            text-align: left; background: var(--bg-input); padding: 1rem; border-radius: 0.5rem;
            margin-bottom: 1.5rem; font-size: 0.8rem; color: var(--text-muted); border: 1px solid var(--border);
        }
        .password-rules ul { padding-left: 1.2rem; margin: 0.5rem 0 0; }
        .password-rules li { margin-bottom: 0.2rem; transition: color 0.2s; }
        .rule-valid { color: var(--success); font-weight: 600; }
        .rule-invalid { color: var(--error); }

        /* BOTONES */
        .btn-primary-lg {
            width: 100%; padding: 0.9rem; background: var(--primary); color: white; border: none;
            border-radius: 0.5rem; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(26, 140, 20, 0.15);
        }
        .btn-primary-lg:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-primary-lg:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }

        .back-link {
            display: block; margin-top: 1.5rem; color: var(--primary); font-weight: 700; text-decoration: none; font-size: 0.9rem;
        }
        .back-link:hover { text-decoration: underline; }

        /* ESTADOS DE CARGA / MENSAJES */
        .status-container { display: none; }
        .status-container.active { display: block; }

        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-card { background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 380px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .modal-icon { display: flex; justify-content: center; margin-bottom: 1rem; }
        .modal-card h3 { font-size: 1.4rem; color: var(--text-main); margin-bottom: 0.5rem; font-weight: 800; }

        @media (max-width: 900px) {
            .brand-panel { display: none; }
            .form-wrapper { padding: 1.5rem; }
        }
    </style>
</head>
<body>

<div class="split-layout">
    <!-- BRANDING -->
    <div class="brand-panel">
        <div class="brand-overlay"></div>
        <div class="brand-content">
            <div class="logos-container">
                <img src="Imagenes/ipn.png" alt="IPN" class="brand-logo">
                <img src="Imagenes/logo blanco.png" alt="UPIICSA" class="brand-logo">
            </div>
            <h1>Sistema de Prácticas Profesionales</h1>
            <p>Unidad Profesional Interdisciplinaria de Ingeniería y Ciencias Sociales y Administrativas</p>
        </div>
    </div>

    <!-- FORMULARIO -->
    <div class="form-panel">
        <div class="form-wrapper">

            <!-- ESTADO: VALIDANDO TOKEN -->
            <div id="loading-view" class="status-container active">
                <div class="spinner"></div>
                <h2 style="font-size: 1.2rem; color: var(--text-main);">Verificando enlace...</h2>
            </div>

            <!-- ESTADO: FORMULARIO ACTIVO -->
            <div id="reset-view" class="status-container">
                <div class="view-header">
                    <h2>Restablecer Contraseña</h2>
                    <p>Crea una nueva contraseña segura para tu cuenta.</p>
                </div>

                <form id="reset-form">
                    <div class="input-group-modern">
                        <label>Nueva Contraseña</label>
                        <input type="password" id="new-password" placeholder="Mínimo 6 caracteres" required>
                    </div>

                    <div class="password-rules">
                        <strong>Requisitos de seguridad:</strong>
                        <ul>
                            <li id="rule-len" class="rule-invalid"> Mínimo 6 caracteres</li>
                            <li id="rule-upper" class="rule-invalid"> Una mayúscula</li>
                            <li id="rule-num" class="rule-invalid"> Un número</li>
                            <li id="rule-spec" class="rule-invalid"> Un carácter especial (@$!%*?&)</li>
                        </ul>
                    </div>

                    <div class="input-group-modern">
                        <label>Confirmar Contraseña</label>
                        <input type="password" id="confirm-password" placeholder="Repite tu contraseña" required>
                    </div>

                    <button type="submit" class="btn-primary-lg" id="btn-reset">Guardar Nueva Contraseña</button>
                </form>
            </div>

            <!-- ESTADO: MENSAJE FINAL (Error/Éxito Estático si falla modal) -->
            <div id="message-view" class="status-container">
                <div id="msg-icon" style="font-size: 3rem; margin-bottom: 1rem;"></div>
                <h2 id="msg-title" style="margin-bottom: 0.5rem; font-size: 1.5rem;"></h2>
                <p id="msg-body" style="color: var(--text-muted);"></p>
                <a href="index.html" class="btn-primary-lg" style="display: inline-block; text-decoration: none; margin-top: 1.5rem;">Ir al Inicio</a>
            </div>

            <a href="index.html" class="back-link" id="link-back">← Volver al inicio de sesión</a>
        </div>
    </div>
</div>

<!-- MODAL -->
<div id="global-modal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-icon" id="modal-icon"></div>
        <h3 id="modal-title">Título</h3>
        <p id="modal-msg">Mensaje</p>
        <button class="btn-primary-lg" id="modal-btn">Aceptar</button>
    </div>
</div>

<script>
    const API_BASE_URL = window.location.origin;
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    document.addEventListener('DOMContentLoaded', () => {
        validateToken();
        setupPasswordValidation();

        document.getElementById('reset-form').addEventListener('submit', handleReset);
    });

    // --- VALIDACIÓN DE TOKEN ---
    async function validateToken() {
        if (!token) {
            showStaticMessage('error', 'Enlace Inválido', 'El enlace de recuperación no es válido o ha expirado.');
            return;
        }

        try {
            const resp = await fetch(`${API_BASE_URL}/api/reset-password/validate?token=${encodeURIComponent(token)}`);
            if (resp.ok) {
                switchView('reset-view');
            } else {
                showStaticMessage('error', 'Enlace Expirado', 'Este enlace ya no es válido. Por favor solicita uno nuevo.');
            }
        } catch (e) {
            showStaticMessage('error', 'Error de Conexión', 'No se pudo verificar el enlace. Intenta más tarde.');
        }
    }

    // --- LÓGICA DE RESTABLECIMIENTO ---
    async function handleReset(e) {
        e.preventDefault();
        const p1 = document.getElementById('new-password').value;
        const p2 = document.getElementById('confirm-password').value;
        const btn = document.getElementById('btn-reset');

        if (!validateRules(p1)) return showModal('Contraseña Débil', 'Cumple con todos los requisitos de seguridad.', 'error');
        if (p1 !== p2) return showModal('Error', 'Las contraseñas no coinciden.', 'error');

        btn.disabled = true;
        btn.textContent = "Guardando...";

        try {
            const resp = await fetch(`${API_BASE_URL}/api/reset-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, newPassword: p1 })
            });

            if (resp.ok) {
                showModal('¡Éxito!', 'Tu contraseña ha sido actualizada correctamente.', 'success', () => {
                    window.location.href = 'index.html';
                });
            } else {
                const txt = await resp.text();
                showModal('Error', txt || 'No se pudo actualizar.', 'error');
            }
        } catch (e) {
            showModal('Error', 'Fallo al conectar con el servidor.', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = "Guardar Nueva Contraseña";
        }
    }

    // --- UTILIDADES DE INTERFAZ ---
    function switchView(id) {
        document.querySelectorAll('.status-container').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        // Ocultar link de volver en loading/reset, mostrar en error
        document.getElementById('link-back').style.display = (id === 'reset-view' || id === 'loading-view') ? 'none' : 'block';
    }

    function showStaticMessage(type, title, body) {
        switchView('message-view');
        const icon = document.getElementById('msg-icon');
        icon.innerHTML = type === 'error'
            ? '<svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
            : '<svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';

        document.getElementById('msg-title').textContent = title;
        document.getElementById('msg-title').style.color = type === 'error' ? 'var(--error)' : 'var(--success)';
        document.getElementById('msg-body').textContent = body;
    }

    function showModal(title, msg, type = 'info', callback = null) {
        const overlay = document.getElementById('global-modal');
        const icon = document.getElementById('modal-icon');
        const btn = document.getElementById('modal-btn');

        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-msg').textContent = msg;

        const icons = {
            success: '<svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>',
            error: '<svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
        };
        icon.innerHTML = icons[type] || icons.error;

        overlay.style.display = 'flex';
        btn.onclick = () => {
            overlay.style.display = 'none';
            if (callback) callback();
        };
    }

    // --- VALIDACIÓN EN TIEMPO REAL ---
    function setupPasswordValidation() {
        const input = document.getElementById('new-password');
        input.addEventListener('input', () => validateRules(input.value));
    }

    function validateRules(val) {
        const rules = {
            len: val.length >= 6,
            upper: /[A-Z]/.test(val),
            num: /\d/.test(val),
            spec: /[!@#$%^&*(),.?":{}|<>]/.test(val)
        };

        updateRule('rule-len', rules.len);
        updateRule('rule-upper', rules.upper);
        updateRule('rule-num', rules.num);
        updateRule('rule-spec', rules.spec);

        return Object.values(rules).every(Boolean);
    }

    function updateRule(id, valid) {
        const el = document.getElementById(id);
        if (valid) {
            el.classList.remove('rule-invalid');
            el.classList.add('rule-valid');
            el.innerHTML = '✓ ' + el.innerText.substring(2); // Cambia bullet por check
        } else {
            el.classList.remove('rule-valid');
            el.classList.add('rule-invalid');
            el.innerHTML = '• ' + el.innerText.substring(2);
        }
    }
</script>
</body>
</html>